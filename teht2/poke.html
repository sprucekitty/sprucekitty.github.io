<html>
<!DOCTYPE html>
<html lang="fi">
<head>
    <title>Kirsin Pokemon haku</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="Digi Intro, HTML, CSS, JSON">
    <meta name="description" content="JSON harjoitussivusto">
    <!--Bootstrapin CSS-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!--bootstrap, bundle-versiossa on mukana myös popper.js-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!--Sitten oma CSS, jolla voi ylikirjoittaa Bootstrapin asetuksia-->
    <link rel="stylesheet" href="style.css"> 
</head>
<body>    
<!--Sivun yläosa, jossa navigaatiopalkki-->
<header>
    <nav id="siteNav" class="navbar navbar-expand-sm navbar-light navbar-custom fixed-top">
        <div class="container-fluid justify-content-center">
            <!-- Hamburger-menu pienille näytöille -->
            <button class="navbar-toggler custom-toggler" type="button" 
            data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar" 
            aria-controls="collapsibleNavbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div id="collapsibleNavbar" class="collapse navbar-collapse justify-content-center">
                <ul class="navbar-nav text-center">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Etusivu</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="oma-tietue.html">Tehtava 1</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="poke.html">Tehtava 2</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="saa.html">Tehtävä 3</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>
<!--Sivun pääsisältö. Container-fluid = koko sivun leveys, p-5 = isot sisämarginaalit -->  
<main class="container-fluid p-5 ">
    <h1>Digitekniikat JSON tehtävä 2</h1>
    <p>JSON-muotoisen tiedon hakua julkisista palveluista.</p>
    <!--Korttimainen paneeli-->
    <div class="container p-5 my-5 rounded-4 brand-panel">
        <h2>Osa 1: Pokemonin haku & Osa2: Pokemon kääntö</h2>
        <!--Hakukenttä ja napit-->
        <input type="text" id="pokemonName" placeholder="Enter pokemon name"><br><br>
        <button onclick="poke()">Hae</button>
        <button onclick="kaanna()">Käännä</button><br><br>
        <!--Viestit/virheilmoitukset-->
        <div id="vastaus"></div>  
        <div id="nimi">Kirjoita laatikkooon Pokemonin nimi</div>
        <div id="ominaisuudet"></div>
        <p id="kuva2"></p>
    </div>
    <!--Listataan esimerkki-Pokemonit avuksi-->
    <div class="container p-5 my-5 rounded-4 brand-panel">
        <h2>Pokemoneja</h2>
        <p>Tässä joitain Pokemonea jos et muista ulkoa. Lista on haettu sivustolta pokeapi.co.</p>
        <div id="pokelista"></div>
    </div>
</main>
<!--Oma JavaScript-->
<script>
    // Säilytetään viimeisin haettu Pokemonin JSON-objekti. Käännä käyttää tätä ilman uutta hakua.
    var lastObj = null;

    function poke(){
        //estetään tyhjä haku
        var raw = document.getElementById("pokemonName").value;
        if (raw.trim() === "") return;
        //Tyhjennetään aiemmat viestit ja ominaisuudet ennen uutta hakua
        document.getElementById("vastaus").innerHTML = "";  
        document.getElementById("ominaisuudet").innerHTML = "";
        //Tallennetaan annettu Poken nimi muuttujaan pokeName, muuttetaan se samalla pieniksi kirjaimiksi
        const pokeName = document.getElementById("pokemonName").value.toLowerCase();
        //Tallennetaan myös nimi talteen muuttujaan name
        let name = document.getElementById("pokemonName").value;
        //Kutsutaan fetchiä haettavan Pokemonin tiedoilla ja liitetään saatu nimi URL:iin
        fetch(`https://pokeapi.co/api/v2/pokemon/${pokeName}`)
        //Muunnetaan vastaus JSON-muotoon
        .then(function (response) {
            return response.json();
        })
        //Käsitellään muunnettu (eli JSON muotoinen) vastaus 
        //Tallennetaan kuvan kääntöä varten
        //Kutsutaan funktiota pokekuva()ja välitetään sille json-vastaus
        .then(function (responseJson) {
            lastObj = responseJson;
            pokekuva(responseJson);
        })
        //Jos tuli jokin virhe 
        .catch(function (error) {
            document.getElementById("vastaus").innerHTML = "<p>Tietoa ei pystytä hakemaan</p>";
        })

        // Näyttää etukuvan ja nimen, sekä tyhjentää hakukentän
        function pokekuva(obj) {
	        //Tallennetaan muuttujan linkki josta löytty Poken kuva
            let pokeurl = obj.sprites.front_default;
	        //Kirjoitetaan kuva, ja nimi sivulla sekä tyhyjennetään hakukenttä
            document.getElementById("kuva2").innerHTML = "<img src=" + pokeurl + ">";
            document.getElementById("nimi").innerHTML = "<b>" + name + "</b>";
            //Tyhjennetään hakukenttä, jotta käyttäjä voi kirjoittaa uuden haun
            document.getElementById("pokemonName").value = "";
        }
    }

    function kaanna(){
        //jos Pokemonia ei ole haettu vielä, annetaan ohje
        if (!lastObj) {
            document.getElementById("vastaus").innerHTML = "<p>Hae ensin Pokemon.</p>";
            return;
        }
        // kentässä on uusi pokemon, jota ei ole vielä haettu, pyydetään hakemaan ensin
        var typed = document.getElementById("pokemonName").value.trim().toLowerCase();
        if (typed && typed !== lastObj.name) {
            document.getElementById("vastaus").innerHTML = "<p>Hae ensin Pokemon.</p>";
            return;
        }
        //Siivotaan mahdollinen aiempi viesti
        document.getElementById("vastaus").innerHTML = ""; 
	    //Tallennetaan muuttujan linkki josta löytty Poken takakuva
        let pokebackurl = lastObj.sprites.back_default;
	    //Kirjoitetaan kuva, ja ominaisuudet sekä tyhyjennetään hakukenttä
        document.getElementById("kuva2").innerHTML = "<img src=" + pokebackurl + ">";
        //Rakennetaan ominaisuudet ja näytetään ne kuvan alla
        let info = "<p>Height: " + lastObj.height + "</p>";
        info += "<p>Weight: " + lastObj.weight + "</p>";
        info += "<p>ID: " + lastObj.id + "</p>";
        document.getElementById("ominaisuudet").innerHTML = info;
        // Tyhjennetään hakukenttä
        document.getElementById("pokemonName").value = "";
    }

    //Haetaan ensimmäiset 100 Pokemon nimeä
    function listaaPokemonit(){
        fetch("https://pokeapi.co/api/v2/pokemon?limit=100")
        .then(function(response){
            return response.json();
        })
        .then(function(data){
            var lista = "<ul>";
                for (var i = 0; i < data.results.length; i++){
                    var nimi = data.results[i].name;
                    var naytto = nimi.charAt(0).toUpperCase() + nimi.slice(1);
                    // Klikkaus täyttää hakukentän mutta EI käynnistä hakua
                    lista += "<li>" + naytto + "</li>";
                }
            lista += "</ul>";
            document.getElementById("pokelista").innerHTML = lista;
        })
        //Mahdollinen virhe jätetään hiljaiseksi (ei sotketa UI:ta)
        .catch(function(){ /* jätetään hiljaiseksi */ });
    }

    //Luodaan lista näkyviin heti sivun latauduttua
    listaaPokemonit();
</script>
</body>
</html>